-- title:  game title
-- author: LAZK
-- desc:   short description
-- script: lua

function is_dyn(x,y)
		return fget(mget(x,y),0)
end

local dirs={
	{0,-1},
	{1,0},
	{0,1},
	{-1,0}
}

function remap(tile,x,y)
	if not fget(tile,0) then
		return
	end
	--tile=tile + 3*((y//3)%4) -- season test
	local c=0
	for k,d in pairs(dirs) do
		if is_dyn(x+d[1],y+d[2]) then c=c+1 end
	end 
	if c==0 or c==4 then
		return tile
	elseif c==1 then
		local rot=2
		for k,d in pairs(dirs) do
			if is_dyn(x+d[1],y+d[2]) then
				return tile-1,0,rot%4
			end
			rot=rot+1
		end
	elseif c==3 then
		local rot=0
		for k,d in pairs(dirs) do
			if not is_dyn(x+d[1],y+d[2]) then
				return tile-1,0,rot%4
			end
			rot=rot+1
		end
	elseif c==2 then
		local s=0
		local rot=-1
		for k,d in pairs(dirs) do
			if s==0 and not is_dyn(x+d[1],y+d[2]) then
				s=1
			end
			if s==1 and is_dyn(x+d[1],y+d[2]) then
				return tile-2,0,rot%4
			end
			rot=rot+1
		end
		return tile-2,0,rot%4
	end
	
	return tile
end

local player={
	x=0,y=0,
	dx=0,dy=0,
	w=16,h=16,
	sprite=257,
	facing="r",
	state="idle"
}

local camera={
	x=0,y=0,
	w=240,h=136
}

local flip_map={r=0,l=1}
local grav=90
local speed=60
local jump=90

function draw(c)
	spr(
		c.sprite,
		c.x-(camera.x-camera.w/2),
		c.y-(camera.y-camera.h/2),
		0,
		1,flip_map[c.facing],0,
		c.w//2,c.h//2
	)
end

function is_solid(x,y)
	return mget(x,y) > 0 and mget(x,y) < 100
end

function update_player(p)
	p.dy=p.dy+grav/60

	-- if hits floor
	if is_solid(p.x//8,(p.y+p.dy/60+p.h)//8) or
	   is_solid((p.x+p.h)//8,(p.y+p.dy/60+p.h)//8) then
		p.dy = 0
	end
	
	-- if hits roof
	if is_solid(p.x//8,(p.y+p.dy/60)//8) or
	   is_solid((p.x+p.h)//8,(p.y+p.dy/60)//8) then
		p.dy = 0
	end
	
	p.y=p.y+p.dy/60

	if btn(3) then
		p.dx=speed
	elseif btn(2) then
		p.dx=-speed
	else
		p.dx=0
	end
	
	if btnp(0) then
		p.dy=-jump
	end

	if is_solid((p.x+p.dx/60)//8,(p.y+p.dy/60)//8) or
	   is_solid((p.x+p.dx/60+p.w)//8,(p.y+p.dy/60)//8) or
	   is_solid((p.x+p.dx/60)//8,(p.y+p.dy/60+p.h)//8) or
	   is_solid((p.x+p.dx/60+p.w)//8,(p.y+p.dy/60+p.h)//8) then
		p.dx=0
	end	
	p.x=p.x+p.dx/60
end

function update_camera(c,p)
	if p.x < c.w/2 then
		c.x=c.w/2
	else
		c.x=p.x
	end
	if p.y < c.h/2 then
		c.y=c.h/2
	else
		c.y=p.y
	end
end

function calc_iso(x,y)
	local xx=4.5*x
	local xy=2*x
	local yx=-4.5*y
	local yy=2*y 
	return xx+yx,xy+yy
end

function map_iso(x,y,w,h,sx,sy,remap)
	for ix=x,x+w,2 do
		for iy=y,y+h,2 do
			if fget(mget(ix,iy),0) then
				local dx,dy=calc_iso(ix,iy)
				spr(mget(ix,iy),dx+sx,dy+sy,0,1,0,0,2,2)
			end
		end
	end
end

function TIC()
	cls()
	map_iso(0,0,32,32,72,32)
end

-- <TILES>
-- 001:000000000000000000000000000000000000000000000000000000000000000d
-- 002:00000000000000000000000000000000000000000000000000000000d0000000
-- 003:0000000d00000dde000ddede0ddeeeeeddeedeefdddeeededdedddeedeeeedde
-- 004:f0000000eff00000deeff000eefeeff0eeeffeffeeeeefffefeffeeffffeeeef
-- 017:00000dde000ddeed0dddedeedeeeeeee0ffeefee000ffeef00000ffe0000000f
-- 018:edd00000ededd000eedeedd0deeeeeefeeefeff0efeff000eff00000f0000000
-- 019:ddedeeefddeeedefdeedeeffddeeeeef0ffeefef000ffeef00000fff0000000f
-- 020:fedeeeeffeeefefffdeeeeeffeeeffffffefeff0feeff000fff00000f0000000
-- 144:000000000000000000000000000000000000000000000000000000000000000d
-- 145:00000000000000000000000d00000dde000ddeed0dddedeedeeeeeeedffeefee
-- 146:0000000000000000d0000000edd00000ededd000eedeedd0deeeeeefeeefeff0
-- 160:00000dde000ddeed0dddedeedeeeeeee0ffeefee000ffeef00000ffe0000000f
-- 161:eddffeefeeeeeffeeeeeeddfeeeeeeefeeefeff0efeff000eff00000f0000000
-- 162:efeff000eff00000f00000000000000000000000000000000000000000000000
-- </TILES>

-- <MAP>
-- 000:304030403040304030403040304030400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 001:314131413141314131413141314131410000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 002:304010201020102010201020102030400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 003:314111211121112111211121112131410000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 004:304010201020102010201020102030400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 005:314111211121112111211121112131410000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 006:304010201020102010201020102030400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 007:314111211121112111211121112131410000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 008:304010201020102010201020102030400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 009:314111211121112111211121112131410000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 010:304010201020102010201020102030400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 011:314111211121112111211121112131410000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 012:304010201020102010201020102030400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 013:314111211121112111211121112131410000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 014:304030403040304030403040304030400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 015:314131413141314131413141314131410000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </MAP>

-- <WAVES>
-- 000:00000000ffffffff00000000ffffffff
-- 001:0123456789abcdeffedcba9876543210
-- 002:0123456789abcdef0123456789abcdef
-- </WAVES>

-- <SFX>
-- 000:020002000200020002000200020002000200020002000200020002000200020002000200020002000200020002000200020002000200020002000200300000000000
-- 001:010611054103510171008100810081009100910091009100910091009100910091009100910091009100910091009100910091009100910091009100200000000000
-- 002:020002000200020002000200020002000200020002000200020002000200020002000200020002000200020002000200020002000200020002000200300000000000
-- 003:030713043302630f830d930ba309a308b308c308d308e308e308f308f308f308f308f308f300f300f300f300f300f300f300f300f300f300f300f300400000000000
-- </SFX>

-- <PATTERNS>
-- 000:b00014000000000000000000600016000000000000000000b00014000000000000000000600016000000000000000000800014000000000000000000b00014000000000000000000800014000000000000000000b00014000000000000000000400014000000000000000000800014000000000000000000400014000000000000000000800014000000000000000000600014000000000000000000a00014000000000000000000600014000000000000000000600016000000000000000000
-- 001:b00026f00026800028000000b00026f00026800028000000b00026f00026800028000000b00026f00026800028000000800026b00026f00026000000800026b00026f00026000000800026b00026f00026000000800026b00026f00026000000400026800026b00026000000400026800026b00026000000400026800026b00026000000400026800026b00026000000600026a00026d00026000000600026a00026d00026000000600026a00026d00026000000600026a00026d00026000000
-- 002:000000000000b0003e000000600038000000b0003e00000000000000000090003e00000060003800000090003e00000000000000000080003e000000b0003800000080003e00000000000000000080003e000000b0003800000040003e00000000000000000040003e00000080003800000040003e00000000000000000040003e00000080003800000080003e00000000000000000080003e000000a00038000000a0003e000000000000000000a0003e00000060003a000000a0003e000000
-- </PATTERNS>

-- <TRACKS>
-- 000:180300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </TRACKS>

-- <FLAGS>
-- 000:00100010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </FLAGS>

-- <PALETTE>
-- 000:1a1c2c5d275db13e53ef7d57ffcd75a7f07038b76425717929366f3b5dc941a6f673eff7f4f4f494b0c2566c86333c57
-- </PALETTE>

